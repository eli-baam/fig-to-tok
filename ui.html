<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    html, body { 
      width: 100%;
      height: 100%;
      margin:0; 
      font:12px/1.4 Pretendard, Inter, system-ui, -apple-system, Segoe UI, Roboto; 
    }
    .wrap {
      display: flex;
      flex-direction: column;
      height: 100%;
      box-sizing: border-box;
      position: relative;
      padding: 20px;
    }  
    .resizer {
      position: absolute; right: 0; bottom: 0;
      width: 12px; height: 12px;
      cursor: se-resize; user-select: none;
      z-index: 9999;
      /* 시각 표시를 원하면 */
      /* background: linear-gradient(135deg, transparent 50%, #888 50%); */
    }
    .header {
      padding: 24px 20px 16px;
      align-items: center;
      display: flex;
      flex-direction: column;
    }
    textarea { 
      background-color: #f5f5f5;
      padding: 20px;
      width:100%; 
      height:100%; 
      font-family: SFMono-Regular, Menlo, monospace; 
      font-size: 10px; 
      line-height: 1.3; 
      border: none;
      color: #999;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    button { 
      background-color: #212121;
      width: 120px;
      height: 44px;
      font-weight: 500;
      font-size: 16px;
      color: white;
      cursor:pointer; 
      border-radius: 8px; 
      border: none;
      transition: all 0.1s ease-in;
    }
    button:active {
      opacity: 0.8;
      transform: translateY(1px);
    }
    h1 { 
      font-size:16px; 
      font-weight:900;
      margin: 4px 0;
    }
    .desc { 
      font-size: 14px;
      margin: 4px 0 20px;
    }
    .note { color:#999; margin:8px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>FIG to TOK</h1>
      <p class="desc">현재 파일의 Variables과 Styles를 토큰으로 저장합니다.</p>
      
      <div class="row">
        <button id="btn-json">JSON</button>
        <button id="btn-scss">SCSS</button>
      </div>
      <div class="note" id="status">대기 중…</div>
    </div>

    <textarea id="preview" readonly></textarea>

    <div class="resizer" id="resizer" title="Drag to resize"></div>
  </div>

  <script>
    let acc = "";
    let filename = "download.txt";
    let mime = "text/plain";
    let assembling = false;
    let expectedChunks = 0;
    let received = 0;

    const statusEl = document.getElementById("status");
    const previewEl = document.getElementById("preview");
    const send = (m)=> parent.postMessage({ pluginMessage: m }, "*");

    document.getElementById("btn-json").onclick = ()=> send({ type: "REQUEST_JSON" });
    document.getElementById("btn-scss").onclick = ()=> send({ type: "REQUEST_SCSS" });

    function setStatus(t){ statusEl.textContent = t; }

    window.onmessage = (e) => {
      const msg = e.data?.pluginMessage;
      if (!msg) return;

      if (msg.type === "ERROR") {
        alert("[FIG to TOK] 오류: " + msg.message);
        return;
      }

      // 단일 텍스트 전송(SCSS 등)
      if (msg.type === "EXPORT_TEXT") {
        const data = msg.data || "";
        previewEl.value = data.slice(0, 5000);
        setStatus(`완료 (${(data.length/1024).toFixed(1)} KB)`);
        const blob = new Blob([data], { type: msg.mime || "text/plain" });
        const url  = URL.createObjectURL(blob);
        const a    = Object.assign(document.createElement("a"), {
          href: url,
          download: msg.filename || "export.txt",
        });
        a.click(); URL.revokeObjectURL(url);
        return;
      }

      // 청크 전송(JSON 등 큰 파일)
      if (msg.type === "EXPORT_BEGIN") {
        acc = ""; filename = msg.filename || filename; mime = msg.mime || mime;
        assembling = true; expectedChunks = msg.chunks|0; received = 0;
        previewEl.value = ""; setStatus(`수신 중… (0/${expectedChunks})`);
        return;
      }
      if (msg.type === "EXPORT_CHUNK") {
        acc += msg.data || ""; received++;
        setStatus(`수신 중… (${received}/${expectedChunks})`);
        return;
      }
      if (msg.type === "EXPORT_END") {
        assembling = false;
        previewEl.value = acc.slice(0, 5000);
        setStatus(`완료 (${(acc.length/1024/1024).toFixed(2)} MB)`);
        const blob = new Blob([acc], { type: mime });
        const url  = URL.createObjectURL(blob);
        const a    = Object.assign(document.createElement("a"), { href:url, download: filename });
        a.click(); URL.revokeObjectURL(url);
        return;
      }
    };

    // 리사이즈 메시지는 그대로 유지
    window.addEventListener("load", () => {
      parent.postMessage({ pluginMessage: { type: "UI_READY" } }, "*");
    });
  </script>

</body>
</html>
