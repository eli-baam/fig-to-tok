<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    html, body { 
      width: 100%;
      height: 100%;
      margin:0; 
      font:12px/1.4 Pretendard, Inter, system-ui, -apple-system, Segoe UI, Roboto; 
    }
    .wrap {
      display: flex;
      flex-direction: column;
      height: 100%;
      box-sizing: border-box;
      position: relative;
      padding: 20px;
    }  
    .resizer {
      position: absolute; right: 0; bottom: 0;
      width: 12px; height: 12px;
      cursor: se-resize; user-select: none;
      z-index: 9999;
      /* 시각 표시를 원하면 */
      /* background: linear-gradient(135deg, transparent 50%, #888 50%); */
    }
    .header {
      padding: 24px 20px 16px;
      align-items: center;
      display: flex;
      flex-direction: column;
    }
    textarea { 
      background-color: #f5f5f5;
      padding: 20px;
      width:100%; 
      height:100%; 
      font-family: SFMono-Regular, Menlo, monospace; 
      font-size: 10px; 
      line-height: 1.3; 
      border: none;
      color: #999;
    }
    button { 
      background-color: #212121;
      height: 48px;
      font-weight: 500;
      font-size: 16px;
      color: white;
      cursor:pointer; 
      border-radius: 12px; 
      border: none;
      width: 50%;
      transition: all 0.1s ease-in;
    }
    button:active {
      opacity: 0.8;
      transform: translateY(1px);
    }
    h1 { 
      font-size:16px; 
      font-weight:900;
      margin: 4px 0;
    }
    .desc { 
      font-size: 14px;
      margin: 4px 0 20px;
    }
    .note { color:#999; margin:8px 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Variables → JSON (tokens)</h1>
      <p class="desc">현재 파일의 Variables를 JSON으로 저장합니다.</p>
      <button id="download" disabled>다운로드</button>
      <div class="note" id="status">대기 중…</div>
    </div>

    <textarea id="preview" readonly></textarea>

    <div class="resizer" id="resizer" title="Drag to resize"></div>
  </div>

  <script>
    let blobUrl = null;
    let assembling = false;
    let expectedChunks = 0;
    let received = 0;
    let parts = []; // 문자열 조각 모음
    let jsonText = "";

    function updateStatus() {
      const s = document.getElementById("status");
      if (assembling) {
        s.textContent = `수신 중… (${received}/${expectedChunks})`;
      } else if (jsonText) {
        s.textContent = `완료 (${(jsonText.length/1024/1024).toFixed(2)} MB)`;
      } else {
        s.textContent = "대기 중…";
      }
    }

    onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === "ERROR") {
        alert("[Variables → JSON] 오류: " + msg.message);
        return;
      }

      if (msg.type === "EXPORT_BEGIN") {
        assembling = true;
        expectedChunks = msg.chunks;
        received = 0;
        parts = [];
        jsonText = "";
        const btn = document.getElementById("download");
        btn.disabled = true;
        updateStatus();
        return;
      }

      if (msg.type === "EXPORT_CHUNK") {
        parts[msg.index] = msg.data;
        received++;
        updateStatus();
        return;
      }

      if (msg.type === "EXPORT_END") {
        assembling = false;
        jsonText = parts.join("");
        parts = [];
        const preview = document.getElementById("preview");
        preview.value = jsonText.slice(0, 5000);

        if (blobUrl) URL.revokeObjectURL(blobUrl);
        blobUrl = URL.createObjectURL(new Blob([jsonText], { type: "application/json" }));

        const btn = document.getElementById("download");
        btn.disabled = false;
        updateStatus();
        return;
      }
    };

    window.addEventListener("load", () => {
      parent.postMessage({ pluginMessage: { type: "UI_READY" } }, "*");
    });

    new ResizeObserver(requestResize).observe(document.body); // 내용 변화에 따라 자동

    // Window Resizer
    let autoResizeEnabled = true;
    function requestResize() {
      if (!autoResizeEnabled) return;
      const r = document.body.getBoundingClientRect();
      parent.postMessage({ pluginMessage: { type: "RESIZE", width: Math.round(r.width), height: Math.round(r.height) } }, "*");
    }

    function postResize(w, h) {
      parent.postMessage({ pluginMessage: { type: "RESIZE", width: w, height: h } }, "*");
    }

    // ---- 자동 리사이즈가 필요하다면, 드래그 중엔 잠시 비활성화
    function requestResizeFromContent() {
      if (!autoResizeEnabled) return;     // ✅ 드래그 중이면 무시
      const rect = document.body.getBoundingClientRect();
      postResize(Math.round(rect.width), Math.round(rect.height));
    }

    // (선택) 내용 변화 감지 자동 리사이즈 — 드래그 중엔 동작 안 함
    const ro = new ResizeObserver(requestResizeFromContent);
    ro.observe(document.body);

    // ---- 드래그 리사이저
    window.addEventListener("DOMContentLoaded", () => {
      const resizer = document.getElementById("resizer");
      if (!resizer) return;

      let startX = 0, startY = 0, startW = 0, startH = 0;

      function onMove(e) {
        const w = Math.max(280, startW + (e.clientX - startX));
        const h = Math.max(160, startH + (e.clientY - startY));
        console.log("[resizer] move →", w, h);           // 🔎 확인용
        postResize(Math.round(w), Math.round(h));
      }
      function onUp(e) {
        window.removeEventListener("pointermove", onMove);
        window.removeEventListener("pointerup", onUp);
        autoResizeEnabled = true;                        // ✅ 드래그 종료 → 자동 리사이즈 복귀
        console.log("[resizer] end");
      }

      resizer.addEventListener("pointerdown", (e) => {
        const rect = document.body.getBoundingClientRect();
        startX = e.clientX; startY = e.clientY;
        startW = rect.width; startH = rect.height;

        autoResizeEnabled = false;                       // ✅ 드래그 시작 → 자동 리사이즈 OFF
        resizer.setPointerCapture(e.pointerId);
        window.addEventListener("pointermove", onMove);
        window.addEventListener("pointerup", onUp);
        console.log("[resizer] start", { startW, startH });
        e.preventDefault();
      });
    });

    

    document.getElementById("download").onclick = () => {
      const a = document.createElement("a");
      const now = new Date();
      const ts = now.toISOString().replace(/[-:]/g,"").slice(0,15).replace("T","-");
      const safe = (document.title || "figma").replace(/[^\w.-]+/g,"_");
      a.href = blobUrl;
      a.download = `${safe}-variables-${ts}.json`;
      a.click();
    };

    window.addEventListener("keydown", e => { if (e.key === "Escape") parent.postMessage({pluginMessage:"CLOSE"},"*"); });
  </script>
</body>
</html>
